<?php
 $a=Array();class Template{protected $b;protected $c;protected $d=Array();protected $f=Array();protected $g=false;protected $h;protected $j;protected $k;protected $l;protected $m;protected $n;protected $o;protected $p;protected $q;protected $r=false;protected $s;protected $t=Array();protected $u;protected $v;protected $w=false;protected $x;protected $y;protected $z=null;protected $aa;protected $bb;protected $cc;protected $dd;protected $ee;protected $ff;protected $a;function __construct(){$gg->_absolute_path=dirname(__FILE__);$gg->_blocks_vars=array();$gg->_output_directories=Array('.');$gg->_utf8_write_treatment='none';$gg->_utf8_read_treatment='none';$gg->_remove_temporary_directory_secure=1;$gg->_remove_folder_secure=1;$gg->_render_depth_level=1;$gg->_render_type='temporary';$gg->_var_delim='%';$gg->_vars=array();session_start();if(count($_REQUEST)>0){if(array_key_exists('PHPSESSID',$_REQUEST)){$gg->_temporary_directory=$_REQUEST['PHPSESSID'];}else{$hh=rand(0,9999999);$gg->_temporary_directory=sha1($hh.time());}}else{$gg->_temporary_directory=sha1($hh.time());}$gg->update_temporary_folders_path();return true;}function __destruct(){$gg->cleansing_render_env();}public function get_blocks_vars(){$ii="<pre>";$ii.=print_r($gg->_blocks_vars);$ii.="</pre>";return $ii;}public function get_mail_recipients(){return $gg->_mail_recipients;}public function get_mail_sender(){return $gg->_mail_sender;}public function get_mail_sender_name(){return $gg->_mail_sender_name;}public function get_mail_subject(){return $gg->_mail_subject;}public function get_output_directories(){return $gg->_output_directories;}public function get_output_name(){return $gg->_output_name;}private function get_php_code($jj){$kk=strrpos($jj,'(');$ll=strrpos($jj,')');$mm=substr($jj,($kk+1),($ll-$kk-1));return $mm;}public function get_render_content(){$nn=false;if($gg->_render_type=='temporary'){if(file_exists($gg->_temporary_folders_path.'/renders/'.$gg->_output_name)){switch($gg->_utf8_read_treatment){case  'none':$nn=file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name);break;case  'encode':$nn=utf8_encode(file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name));break;case  'decode':$nn=utf8_decode(file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name));break;}}else{die('Template->get_render_content() with render_type="temporary" failed. The render has not been done or the file not exist. Use Template->render();');}}else{if(file_exists($gg->_output_directories[0].'/'.$gg->_output_name)){switch($gg->_utf8_read_treatment){case  'none':$nn=file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name);break;case  'encode':$nn=utf8_encode(file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name));break;case  'decode':$nn=utf8_decode(file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name));break;}}else{die('Template->get_render_content() with render_type="permanent" failed. The render has not been done or the file not exist. Use Template->render();');}}return $nn;}private function get_template_path($jj){$kk=strrpos($jj,'(');$ll=strrpos($jj,')');$oo=substr($jj,($kk+1),($ll-$kk-1));return $oo;}public function get_template_source(){return $gg->_template_source;}public function get_vars(){return print_r($gg->_vars);}public function get_vars_delim(){return $gg->_var_delim;}public function set_blocks_vars($pp){$gg->_blocks_vars=$pp;return true;}public function set_keep_temp_file($qq){$gg->_keep_temp_file=$qq;return true;}public function set_mail_recipients(){$rr=func_get_args();$ss;for($tt=0;$tt<count($rr);$tt++){$ss.=($ss==null)?$rr[$tt]:'; '.$rr[$tt];}$gg->_mail_recipients=$ss;return true;}public function set_mail_sender($uu){$gg->_mail_sender=$uu;return true;}public function set_mail_sender_name($vv){$gg->_mail_sender_name=$vv;return true;}public function set_mail_subject($ww){$gg->_mail_subject=$ww;return true;}public function set_output_directories($xx){$gg->cleansing_render_env(true);$gg->_output_directories=func_get_args();$gg->update_temporary_folders_path();return true;}public function set_output_name($yy){$gg->_output_name=$yy;return true;}public function set_render_type($zz){if($zz=='temporary' OR $zz=='permanent'){$gg->_render_type=$zz;return true;}else{die('Template->set_render_type() failed. A wrong value has been sent. The accepted values are "temporary" or "permanent".');}}public function set_template_source($aaa){$gg->_template_source=$aaa;return true;}public function set_temporary_repository($bbb){$gg->cleansing_render_env(true);$gg->_temporary_repository=$bbb;$gg->update_temporary_folders_path();return true;}public function set_utf8_read_treatment($ccc){$gg->_utf8_read_treatment=$ccc;return true;}public function set_utf8_write_treatment($ccc){$gg->_utf8_write_treatment=$ccc;return true;}public function set_vars($pp){$gg->_vars=$pp;return true;}public function set_vars_delim($ddd){$gg->_var_delim=$ddd;return true;}public function debugPath(){$eee=scandir('./');echo "<pre>";echo "Below, the neighborhood of the current folder where the class is executed : \n\n";print_r($eee);echo "</pre>";}public function display(){if($gg->_render_type=='temporary'){if(file_exists($gg->_temporary_folders_path.'/renders/'.$gg->_output_name)){switch($gg->_utf8_read_treatment){case  'none':echo file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name);break;case  'encode':echo utf8_encode(file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name));break;case  'decode':echo utf8_decode(file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name));break;}}else{die('Template->display() with render_type="temporary" failed. The render has not been done or the file not exist. Use Template->render();');}}else{if(file_exists($gg->_output_directories[0].'/'.$gg->_output_name)){switch($gg->_utf8_read_treatment){case  'none':echo file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name);break;case  'encode':echo utf8_encode(file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name));break;case  'decode':echo utf8_decode(file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name));break;}}else{die('Template->display() with render_type="permanent" failed['.$gg->_output_name.']. The render has not been done or the file not exist. Use Template->render();');}}return true;}public function help(){if(file_exists($gg->_absolute_path.'/Help/help.php')&&file_exists($gg->_absolute_path.'/Help/help.tpl')){require $gg->_absolute_path.'/Help/help.php';help($gg->_absolute_path);}else{echo "Template->help() :: The manual seems unavailable. Please check if the help folder and its files are present.";}}public function show_warnings(){echo "<pre>";if(count($gg->_warnings)>0){for($tt=0;$tt<count($gg->_warnings);$tt++){echo $gg->_warnings[$tt][0].' ---> '.$gg->_warnings[$tt][1]."\n";}}else{echo "Template->show_warnings() :: There is no error recorded in the log.";}echo "</pre>";}public function cleansing_render_env($fff=false){if(!$gg->_keep_temp_file OR $fff){$gg->remove_folder($gg->_temporary_folders_path.'/buffers');$gg->remove_folder($gg->_temporary_folders_path.'/renders');$gg->remove_folder($gg->_temporary_folders_path);}$gg->_render_env_exist=false;}private function close_template_file($ggg){if(gettype($gg->_templates_files_res[$ggg])=='resource'){fclose($gg->_templates_files_res[$ggg]);$gg->_template_file_res[$ggg]=null;}else{die('Template->close_template_file() failed; The template "'.$ggg.'" is not opened.');}}private function close_temporary_render_file(){if(gettype($gg->_temporary_render_file_res)=='resource'){fclose($gg->_temporary_render_file_res);$gg->_temporary_render_file_res=null;$gg->_temporary_file_openned=false;}else{die('Template->close_temporary_render_file() failed; Currently, there no file opened to close');}return true;}private function make_render_env(){if($gg->_temporary_repository!=null){@mkdir($gg->_temporary_repository,0777);@mkdir($gg->_temporary_folders_path);@mkdir($gg->_temporary_folders_path.'/buffers',0777);@mkdir($gg->_temporary_folders_path.'/renders',0777);}else{if(file_exists($gg->_output_directories[0])){@mkdir($gg->_temporary_folders_path);@mkdir($gg->_temporary_folders_path.'/buffers',0777);@mkdir($gg->_temporary_folders_path.'/renders',0777);}else{die('Template->make_render_env() failed; The output directory "'.$gg->_output_directories[0].'" doesn\'t exist');}}}private function move_file(){foreach($gg->_output_directories AS $hhh=>$iii){@copy($gg->_temporary_folders_path.'/renders/'.$gg->_output_name,$gg->_output_directories[$hhh].'/'.$gg->_output_name);}}private function open_template_file($ggg){if(file_exists($ggg)){$gg->_templates_files_res[$ggg]=fopen($ggg,'r');}else{die('Template->open_template_file() failed. The template "'.$ggg.'" doesn\'t not exist. Please check the path.');}return true;}private function open_temporary_render_file(){if($gg->_output_name!=null){if(file_exists($gg->_temporary_folders_path.'/renders')){$gg->_temporary_render_file_res=fopen($gg->_temporary_folders_path.'/renders/'.$gg->_output_name,'w+');$gg->_temporary_file_openned=true;}else{die('Template->open_temporary_render_file() failed.');}}else{die('Template->open_temporary_render_file() failed. The output name is undefined. Use Template->set_output_name($name);');}return true;}private function prepare_buffers($ggg){$jjj='';$kkk='';$lll=&$jjj;$mmm=&$kkk;$nnn=false;$ooo=false;$ppp=Array();$qqq=-1;$rrr=Array();while($sss=fgets($gg->_templates_files_res[$ggg])){$ttt='#<!-- BEGIN_BLOCK#';$uuu='#<!-- END_BLOCK '.$lll.'#';$vvv="#<!-- BEGIN_PHP#";$www="#<!-- END_PHP ".$mmm."#";if(preg_match($vvv,$sss)){$kkk=explode(' ',$sss);$kkk=$kkk[2];if(!array_key_exists($kkk,$gg->_buffered_php)){$gg->_buffered_php[$kkk]=fopen($gg->_temporary_folders_path.'/buffers/'.$kkk.'.php','w+');}else{die('Template->prepare_buffer() failed; The renderiing faile because the php block code "'.$kkk.'" is already declared in the template.');}$ooo=true;$ppp[$kkk]=false;}if(preg_match($ttt,$sss)){$jjj=explode(' ',$sss);$jjj=$jjj[2];if(!array_key_exists($jjj,$gg->_buffered_blocks)){$gg->_buffered_blocks[$jjj]=fopen($gg->_temporary_folders_path.'/buffers/'.$jjj.'.tmp','w+');}else{die('Template->prepare_buffers() failed; The rendering failed because the block "'.$jjj.'" is already declared in the template.');}$nnn=true;$qqq++;$rrr[$qqq]=$jjj;}if($ooo){$xxx='#<!-- END_PHP#';$yyy='#<!-- BEGIN_PHP#';if(!preg_match($yyy,$sss)AND!preg_match($xxx,$sss)){$sss=$gg->render_code($sss);fputs($gg->_buffered_php[$kkk],$sss);}}if($nnn){if($ooo){if(!$ppp[$kkk]){$zzz="<!-- EVAL_PHP ($kkk) -->\n";for($tt=$qqq;$tt>-1;$tt--){$aaaa=$rrr[$tt];fputs($gg->_buffered_blocks[$aaaa],$zzz);}$ppp[$kkk]=true;}}else{for($tt=$qqq;$tt>-1;$tt--){$aaaa=$rrr[$tt];fputs($gg->_buffered_blocks[$aaaa],$sss);}}}if(preg_match($www,$sss)){fclose($gg->_buffered_php[$kkk]);$ooo=false;}if(preg_match($uuu,$sss)){fclose($gg->_buffered_blocks[$jjj]);$qqq=$qqq-1;if($qqq>-1){$jjj=$rrr[$qqq];}else{$jjj='';$nnn=false;}}}}public function remove_folder($bbbb){if(is_dir($bbbb)){$cccc=scandir($bbbb);$dddd=false;for($tt=2;$tt<count($cccc);$tt++){if(is_file($bbbb.'/'.$cccc[$tt])){if(!unlink($bbbb.'/'.$cccc[$tt])){$dddd=true;$gg->_warnings[]=Array(date('Y.m.d - H:i.s',time()),'Template->remove_folder :: instance '.$gg->_remove_folder_secure.' :: The deletion of the file '.$cccc[$tt].' in folder '.$bbbb.' failed. Retry in new instance.');}}}if($gg->_remove_folder_secure<20){if(!$dddd){try{rmdir($bbbb);$gg->_remove_folder_secure=1;return true;}catch(Exception $eeee){$gg->_warnings[]=Array(date('Y.m.d - H:i.s',time()),'Template->remove_folder :: instance '.$gg->_remove_folder_secure.' :: '.$eeee->getMessage());$gg->_remove_folder_secure++;$gg->remove_folder($bbbb);}}else{$gg->_remove_folder_secure++;$gg->remove_folder($bbbb);}}else{$gg->_remove_folder_secure=1;$gg->show_warnings();return false;}}else{$gg->_warnings[]=Array(date('Y.m.d - H:i.s',time()),'Template->remove_folder :: The folder '.$bbbb.' does not exist.');return false;}}public function render($ggg=null){if($gg->_var_delim!=''){global $a;$jjj;$kkk;$lll=&$jjj;$mmm=&$kkk;$ffff=false;$gggg=false;if($gg->_template_source!=null){$ggg=($ggg===null)?$gg->_template_source:$ggg;}else{die('Template->render() failed; The source template is not defined. Use Template->set_template_source($template) before;');}if(!$gg->_render_env_exist){$gg->make_render_env();$gg->_render_env_exist=true;}if(!$gg->_temporary_file_openned){$gg->open_temporary_render_file();}$gg->open_template_file($ggg);$gg->_buffered_blocks=Array();$gg->_buffered_php=Array();$gg->prepare_buffers($ggg);fseek($gg->_templates_files_res[$ggg],0);while($sss=fgets($gg->_templates_files_res[$ggg])){$ttt='#<!-- BEGIN_BLOCK#';$uuu='#<!-- END_BLOCK '.$lll.'#';$hhhh='#<!-- INCLUDE_TEMPLATE#';$vvv='#<!-- BEGIN_PHP #';$www='#<!-- END_PHP#';if(preg_match($hhhh,$sss)AND!$ffff){$gg->_render_depth_level++;$sss=$gg->render_code($sss);$gg->render($gg->get_template_path($sss));}if(!$ffff AND preg_match($vvv,$sss)){$kkk=explode(' ',$sss);$kkk=$kkk[2];$iiii=file_get_contents($gg->_temporary_folders_path.'/buffers/'.$kkk.'.php');ob_start();$jjjj=eval($iiii);$kkkk=ob_get_contents();ob_end_clean();$gg->rendering_line($kkkk,$gg->_vars);$gggg=true;}if(preg_match($ttt,$sss)){$jjj=explode(' ',$sss);$jjj=$jjj[2];$gg->rendering_block($jjj,$gg->_blocks_vars[$jjj]);$ffff=true;}if(preg_match($www,$sss)){$gggg=false;}if(preg_match($uuu,$sss)){$ffff=false;$jjj='';}if(!$ffff AND!$gggg){$uuu='#<!-- END_BLOCK#';if(!preg_match($uuu,$sss)&&!preg_match($hhhh,$sss)){$gg->rendering_line($sss,$gg->_vars);}}}$gg->close_template_file($ggg);if($gg->_render_depth_level<=1){$gg->close_temporary_render_file();$gg->_temporary_file_openned=false;if($gg->_render_type=='permanent'){$gg->move_file();}}else{$gg->_render_depth_level--;}}else{die('Template->render() failed. The vars delimiter is not defined. Use Template->set_vars_delim($delim);');}return $gg;}private function render_code($sss){$llll=substr_count($sss,$gg->_var_delim)/2;$mmmm=0;if($llll>0){foreach($gg->_vars as $hhh=>$iii){$nnnn='#'.$gg->_var_delim.$hhh.$gg->_var_delim.'#';if(preg_match($nnnn,$sss)){$sss=preg_replace($nnnn,$iii,$sss);$oooo=substr_count($sss,$gg->_var_delim)/2;$mmmm=$llll-$oooo;}if($mmmm===$llll){break;}}}return $sss;}private function rendering_block($pppp,$qqqq){global $a;$jjj;$lll=&$jjj;$ffff=false;$rrrr=fopen($gg->_temporary_folders_path.'/buffers/'.$pppp.'.tmp','r');for($tt=0;$tt<count($qqqq);$tt++){fseek($rrrr,0);while($ssss=fgets($rrrr)){$ttt='#<!-- BEGIN_BLOCK#';$uuu='#<!-- END_BLOCK '.$lll.'#';$hhhh='#<!-- INCLUDE_TEMPLATE#';$tttt="#<!-- EVAL_PHP#";if(preg_match($hhhh,$ssss)AND!$ffff){$gg->_render_depth_level++;$ssss=$gg->render_code($ssss);$gg->render($gg->get_template_path($ssss));}if(preg_match($ttt,$ssss)){$jjj=explode(' ',$ssss);$jjj=$jjj[2];if($jjj!=$pppp){$gg->rendering_block($jjj,$qqqq[$tt][$jjj]);$ffff=true;};;;;};;;if(preg_match($uuu,$ssss)){$ffff=false;}if(preg_match($tttt,$ssss)){$uuuu=$gg->get_php_code($ssss);$iiii=file_get_contents($gg->_temporary_folders_path.'/buffers/'.$uuuu.'.php');ob_start();$jjjj=eval($iiii);$ssss=ob_get_contents();ob_end_clean();}if(!$ffff&&(!preg_match('#<!-- BEGIN_BLOCK#',$ssss)&&!preg_match('#<!-- END_BLOCK#',$ssss)&&!preg_match('#<!-- INCLUDE_TEMPLATE#',$ssss))){$gg->rendering_line($ssss,$qqqq[$tt]);};;;};;};}private function rendering_line($sss,$qqqq){$llll=substr_count($sss,$gg->_var_delim)/2;$mmmm=0;if($llll>0){foreach($qqqq as $hhh=>$iii){if(gettype($iii)!='array'){$nnnn='#'.$gg->_var_delim.$hhh.$gg->_var_delim.'#';if(preg_match($nnnn,$sss)){$sss=preg_replace($nnnn,$iii,$sss);$oooo=substr_count($sss,$gg->_var_delim)/2;$mmmm=$llll-$oooo;}if($mmmm===$llll){break;}}}}switch($gg->_utf8_write_treatment){case  'none':fputs($gg->_temporary_render_file_res,$sss);break;case  'encode':fputs($gg->_temporary_render_file_res,utf8_decode($sss));break;case  'decode':fputs($gg->_temporary_render_file_res,utf8_encode($sss));break;}}public function sendMail(){if($gg->_mail_recipients!=null){if($gg->_mail_subject!=null){if($gg->_mail_sender!=null){$vvvv="From: ".$gg->_mail_sender_name."<".$gg->_mail_sender.">\n";$vvvv.="X-Mailer: PHP ".phpversion()."\n";$vvvv.="Reply-To:".$gg->_mail_sender."\n";$vvvv.="Organization: neoblaster.fr\n";$vvvv.="X-Priority: 3 (Normal)\n";$vvvv.="Mime-Version: 1.0\n";$vvvv.="Content-Type: text/html; charset=\"UTF-8\"";$vvvv.="Content-Transfer-Encoding: 8bit\n";$vvvv.="Date:".date("D, d M Y h:s:i")." +0300\n";switch($gg->_utf8_read_treatment){case  'none':if($gg->_render_type=='temporary'){$wwww=file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name);}else{$wwww=file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name);}break;case  'encode':if($gg->_render_type=='temporary'){$wwww=utf8_encode(file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name));}else{$wwww=utf8_encode(file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name));}break;case  'decode':if($gg->_render_type=='temporary'){$wwww=utf8_decode(file_get_contents($gg->_temporary_folders_path.'/renders/'.$gg->_output_name));}else{$wwww=utf8_decode(file_get_contents($gg->_output_directories[0].'/'.$gg->_output_name));}break;}mail($gg->_mail_recipients,$gg->_mail_subject,$wwww,$vvvv);}else{die('Template->sendMail() failed. The mail sender is undefined. Use Template->set_mail_sender($sender);');}}else{die('Template->sendMail() failed. The mail subject is undefined. Use Template->set_mail_subject($subject);');}}else{die('Template->sendMail() failed. The mails recipients are undefined. Use Template->set_mail_recipients(mail(s));');}return true;}private function update_temporary_folders_path(){$gg->_temporary_folders_path=($gg->_temporary_repository!=null)?$gg->_temporary_repository.'/'.$gg->_temporary_directory:$gg->_output_directories[0].'/'.$gg->_temporary_directory;}}?>