<?php
/** -------------------------------------------------------------------------------------------------------------------- ** 
/** -------------------------------------------------------------------------------------------------------------------- ** 
/** ---																																					--- **
/** --- 											-----------------------------------------------											--- **
/** ---															{ duplicate_item.php }															--- **
/** --- 											-----------------------------------------------											--- **
/** ---																																					--- **
/** ---		TAB SIZE			: 3																													--- **
/** ---																																					--- **
/** ---		AUTEUR			: Nicolas DUPRE																									--- **
/** ---																																					--- **
/** ---		RELEASE			: 15.04.2017																										--- **
/** ---																																					--- **
/** ---		FILE_VERSION	: 1.0 NDU																											--- **
/** ---																																					--- **
/** ---																																					--- **
/** --- 														---------------------------														--- **
/** ---																{ G I T H U B }																--- **
/** --- 														---------------------------														--- **
/** ---																																					--- **
/** ---		Automatize url?ts=3 :																												--- **
/** ---																																					--- **
/** ---			https://chrome.google.com/webstore/detail/tab-size-on-github/ofjbgncegkdemndciafljngjbdpfmbkn/related	--- **
/** ---																																					--- **
/** ---																																					--- **
/** --- 														-----------------------------														--- **
/** --- 															{ C H A N G E L O G } 															--- **
/** --- 														-----------------------------														--- **	
/** ---																																					--- **
/** ---																																					--- **
/** ---		VERSION 1.0 : 15.04.2017 : NDU																									--- **
/** ---		------------------------------																									--- **
/** ---			- Première release																												--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **

	Objectif du script :
	---------------------
	
	Description fonctionnelle :
	----------------------------
	
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---													PHASE 1 - INITIALISATION DU SCRIPT													--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** > Chargement des Paramètres **/
	setup("/Setups", Array("application", "pdo", "sessions"), 'setup.$1.php');

/** > Ouverture des SESSIONS Globales **/
/** > Chargement des Classes **/
/** > Chargement des Configs **/
/** > Chargement des Fonctions **/
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---												PHASE 2 - CONTROLE DES AUTORISATIONS													--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
if(!isset($_SESSION["MGDG-ADMIN"]) && !$_SESSION["MDGD-ADMIN"]) exit;



/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---												PHASE 3 - INITIALISAITON DES DONNEES													--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
/** > Déclaration des variables **/
	$ID;			// STRING			:: Identifiant de l'objet
	$extend;		// STRING			:: Code d'extension de l'objet (Empowered, Mythical)
	$query;		// STRING			:: Requête SQL à executer
	$pQuery;		// PDOStatement	:: Reuqête préparée à partir de $query
	$faQuery;	// ARRAY				:: Donnée parsée
	$tag;			// STRING			:: Récupération du tag de l'objet duppliqué

/** > Initialisation des variables **/
	$ID = $_POST["id"];
	$extend = $_POST["extend"];

/** > Déclaration et Intialisation des variables pour le moteur (référence) **/


/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---									PHASE 4 - EXECUTION DU SCRIPT DE TRAITEMENT DE DONNEES										--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
/** > 1. Requête pour récupérer les informations **/
$query = "SELECT * FROM ITEMS WHERE ID = :id";
$pQuery = $PDO->prepare($query);
$pQuery->execute(Array(":id" => $ID));
$faQuery = $pQuery->fetch(PDO::FETCH_ASSOC);



/** > 2. Requête de dupplication **/
//--- Modifications des valeurs
//──┐ Récupération du tag
$tag = $faQuery["TAG"];

//──┐ Mise à jour de l'extend
$faQuery["EXTEND"] = $extend;


//--- Manipulations des champs
//──┐ Supprimer le champs ID
array_shift($faQuery);

//──┐ Récupération du nom des champs 
$fields = array_keys($faQuery);

//──┐ Création des tokens
$tokens = array_map(function($el){
	return ":".$el;
}, $fields);

//──┐ Echapper les champs
$fields = array_map(function($el){
	return "`$el`";
}, $fields);

//──┐ Tranformer les champs en indicateur token
$faQuery = array_combine($tokens, $faQuery);


//--- Requête SQL
//──┐ Composition
$query = "INSERT INTO ITEMS (".implode(",",$fields).") VALUES (".implode(",",$tokens).")";
try {
	//──┐ Préparation
	$pQuery = $PDO->prepare($query);
	//──┐ Execution
	$pQuery->execute($faQuery);
} catch (Exception $e){
	$e->getMessage();
}



/** > 3. Requête de récupération de l'ID créer **/
$query = "SELECT MAX(ID) AS NEW_ID FROM ITEMS WHERE TAG = :tag";
$pQuery = $PDO->prepare($query);
$pQuery->execute(Array(":tag" => $tag));
$faQuery = $pQuery->fetch(PDO::FETCH_ASSOC);

echo '{"ID":'.$faQuery["NEW_ID"].'}';



/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---											PHASE 5 - GENERATION DES DONNEES DE SORTIE												--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---												PHASE 6 - AFFICHER LES SORTIES GENEREE													--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
/** > Création du moteur **/
/** > Configuration du moteur **/
/** > Envoie des données **/
/** > Execution du moteur **/
?>