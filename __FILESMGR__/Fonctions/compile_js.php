<?php
/** -------------------------------------------------------------------------------------------------------------------- ** 
/** -------------------------------------------------------------------------------------------------------------------- ** 
/** ---																																					--- **
/** --- 											-----------------------------------------------											--- **
/** --- {}--- **
/** --- 											-----------------------------------------------											--- **
/** ---																																					--- **
/** ---		AUTEUR 	: Nicolas DUPRE																											--- **
/** ---																																					--- **
/** ---		RELEASE	: xx.xx.2016																												--- **
/** ---																																					--- **
/** ---		VERSION	: 1.0																															--- **
/** ---																																					--- **
/** ---																																					--- **
/** --- 														-----------------------------														--- **
/** --- 															{ C H A N G E L O G } 															--- **
/** --- 														-----------------------------														--- **	
/** ---																																					--- **
/** ---																																					--- **
/** ---		VERSION 1.0 : xx.xx.2016																											--- **
/** ---		------------------------																											--- **
/** ---			- Première release																												--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **

	Objectif du script :
	---------------------
	
	Description fonctionnelle :
	----------------------------
	
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---													PHASE 1 - INITIALISATION DU SCRIPT													--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** > Chargement des Paramètres **/
/** > Ouverture des SESSIONS Globales **/
/** > Chargement des Classes **/
	require_once '../Classes/class.JavaScriptPacker.php';

/** > Chargement des Configs **/
/** > Chargement des Fonctions **/
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---												PHASE 2 - CONTROLE DES AUTORISATIONS													--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---												PHASE 3 - INITIALISAITON DES DONNEES													--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
/** > Déclaration des variables **/
$compiling_output;	// STRING	:: Buffer de sortie à afficher dans un second temps
$JS_files;				// ARRAY		:: Liste des fichiers JS traités

/** > Initialisation des variables **/
$JS_files = Array();

/** > Déclaration et Intialisation des variables pour le moteur (référence) **/
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---									PHASE 4 - EXECUTION DU SCRIPT DE TRAITEMENT DE DONNEES										--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
/** Déclaration de la fonction de lecture et de compilation **/
ob_start();

function compile_js($folder_path){
	global $JS_files;
	
	$directory = scandir($folder_path);
	$exclude_values = Array('.', '..');
	
	foreach($directory as $key => $value){
		$full_path = $folder_path.'/'.$value;
		
		if(!in_array($value, $exclude_values)){
			if(is_dir($full_path)){
				compile_js($full_path);
			} else {
				$file = fopen($full_path, 'r');
				$compile_instruction = fgets($file);
				fclose($file);
				
				$compile = true; 
				
				if(preg_match('#^\/\/\#\!\/#', $compile_instruction)){
					$compile_instruction = str_replace('//#!/', '', $compile_instruction);
					
					$matches = Array();
					
					preg_match('#^(compile)\s?=\s?(true|false)#i', $compile_instruction, $matches);
					
					if(strtolower($matches[1]) === 'compile' && strtolower($matches[2]) === 'false'){
						$compile = false;
					}
				}
				
				if($compile){
					if(preg_match('#\.js$#', $value)){
						$output_path = $folder_path;
						$output_file = preg_replace('#\.js$#i', '.jsc', $value);
						
						$JS_files[] = $full_path;
						
						$script = file_get_contents("$folder_path/$value");
						
						$packer = new JavaScriptPacker($script, 'Normal', true, false);
						
						file_put_contents("$folder_path/$output_file", $packer->pack());
					}
				}
			}
		}
	}
}

/** Déclenchement de la fonction de lecture et de compilation **/
compile_js('../../Scripts');
$compiling_output = ob_get_contents();
ob_end_clean();

/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---											PHASE 5 - GENERATION DES DONNEES DE SORTIE												--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/

/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** ---																																					--- **
/** ---												PHASE 6 - AFFICHER LES SORTIES GENEREE													--- **
/** ---																																					--- **
/** -------------------------------------------------------------------------------------------------------------------- **
/** -------------------------------------------------------------------------------------------------------------------- **/
echo "Compilations des fichiers suivants :\n\n";

foreach($JS_files as $key => $value){
	echo "\t$value\n";
}

echo "\n";
echo $compiling_output;

/** > Création du moteur **/
/** > Configuration du moteur **/
/** > Envoie des données **/
/** > Execution du moteur **/
?>